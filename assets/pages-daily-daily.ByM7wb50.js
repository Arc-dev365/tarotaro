import{z as t,A as e,v as a,b as r,d as s,c as i,w as o,i as n,o as d,f as l,p as c,k as h,t as g,j as u,x as m,F as y,y as f,g as p,q as w,l as R,B as S}from"./index-D6euLAw-.js";import{d as _,s as C,a as T}from"./share-save-utils.D_HH1R20.js";import{p as D,a as k}from"./ai-insight-service.C3Q3b0vJ.js";import{T as $,a as v}from"./TarotReading.Q5-8oYaX.js";import{_ as I}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{_ as H}from"./start.CamMrkbd.js";const x=t("tarot",{state:()=>({currentCards:[],currentReading:"",formattedReading:"",history:{},isDrawing:!1,isReading:!1,drawingProgress:0,currentDate:"",hasTodayReading:!1,refreshTimeText:""}),getters:{todayReading:t=>{const e=(new Date).toISOString().split("T")[0];return t.history[e]||null},sortedHistory:t=>Object.entries(t.history).sort(([t],[e])=>new Date(e)-new Date(t)).map(([t,e])=>({date:t,...e}))},actions:{setCurrentDate(){const t=new Date,e=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0");this.currentDate=`${e}年${a}月${r}日`},checkTodayReading(){this.loadHistory();const t=(new Date).toISOString().split("T")[0];this.history[t]?(this.hasTodayReading=!0,this.calculateRefreshTime()):this.hasTodayReading=!1},calculateRefreshTime(){const t=new Date,e=new Date(t);e.setDate(e.getDate()+1),e.setHours(0,0,0,0);const a=e-t,r=Math.floor(a/36e5),s=Math.floor(a%36e5/6e4);this.refreshTimeText=`${r}小时${s}分钟后可重新抽取`},async startDrawing(){if(!this.isDrawing)return this.isDrawing=!0,this.drawingProgress=0,this.currentCards=[],new Promise(t=>{const e=setInterval(()=>{this.drawingProgress+=5;const a=this.currentCards.map(t=>t.id);this.drawingProgress>=33&&this.currentCards.length<1||this.drawingProgress>=66&&this.currentCards.length<2?this.currentCards.push(this.drawMajorArcanaCard(a)):this.drawingProgress>=100&&(this.currentCards.push(this.drawMajorArcanaCard(a)),clearInterval(e),setTimeout(()=>{this.isDrawing=!1,t()},500))},100)})},drawMajorArcanaCard:(t=[])=>_(1,t,"major")[0],async startReading(){this.isReading=!0,this.currentReading="",this.formattedReading='<div id="streaming-content"></div>',D.start("今日塔罗解读"),this.formatReading();try{console.log("正在使用后端AI服务生成解读...");const t=await k.generateAIInsight(this.currentCards,"threeCard","今日运势","daily","",t=>{this.currentReading=t,this.formatReading()});if(t&&t.includes("很抱歉，解读生成失败"))throw console.error("检测到错误消息:",t),new Error("后端AI服务生成解读失败");const e=D.end("今日塔罗解读");console.log(`✅ 今日塔罗解读生成完成，总耗时: ${e}ms，内容长度: ${t.length}字符`),this.saveTodayReading(),this.isReading=!1}catch(t){throw console.error("后端AI服务生成解读失败:",t),D.end("今日塔罗解读"),s({title:`AI解读失败: ${t.message}`,icon:"none",duration:3e3}),this.currentReading="",t}},formatReading(){if(D.start("格式化解读"),!this.currentReading||""===this.currentReading.trim())return this.formattedReading='<div id="streaming-content"></div>',void D.end("格式化解读");let t=this.currentReading.replace(/^#\s+(.+)$/gm,"<h3>$1</h3>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*([^\*]+)\*/g,"<em>$1</em>").replace(/^(\d+\.\s+)(.*?)$/gm,"<li>$2</li>").replace(/^-\s+(.+)$/gm,"<li>$1</li>").replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>");t.startsWith("<h3>")||t.startsWith("<p>")||(t="<p>"+t),t.endsWith("</p>")||(t+="</p>"),t=t.replace(/(<li>.*?<\/li>)+/g,"<ul>$&</ul>"),this.formattedReading=t,D.end("格式化解读")},saveTodayReading(){const t=(new Date).toISOString().split("T")[0];this.history[t]={date:this.currentDate,cards:this.currentCards,reading:this.currentReading},this.saveHistory(),this.hasTodayReading=!0,this.calculateRefreshTime()},saveHistory(){r("tarot_history",this.history)},loadHistory(){const t=a("tarot_history");t&&(this.history=t)},clearHistory(){this.history={},e("tarot_history")},resetToInitial(){this.currentCards=[],this.currentReading="",this.formattedReading="",this.isDrawing=!1,this.isReading=!1,this.drawingProgress=0}}});const P=I({components:{TarotDrawing:v,TarotReading:$,TarotHistory:I({name:"TarotHistory",props:{title:{type:String,default:"历史记录"},historyItems:{type:Array,default:()=>[]},emptyText:{type:String,default:"暂无历史记录"},showClearButton:{type:Boolean,default:!0}},data:()=>({showConfirmDialog:!1}),computed:{isEmpty(){return!this.historyItems||0===this.historyItems.length}},methods:{getPreviewText(t){if(D.start("预览文本处理"),!t)return D.end("预览文本处理"),"无解读内容";try{const e=t.replace(/^#\s+(.+)$/gm,"$1").replace(/\*\*(.*?)\*\*/g,"$1").replace(/\*([^\*]+)\*/g,"$1").replace(/^(\d+\.\s+|-\s+)(.*?)$/gm,"$2").replace(/\n/g," "),a=e.length>30?e.substring(0,30)+"...":e,r=D.end("预览文本处理");return console.log(`📄 预览文本处理完成，耗时: ${r}ms`),a}catch(e){return console.error("处理预览文本出错:",e),D.end("预览文本处理"),t.substring(0,30)+"..."}},selectItem(t,e){D.start("历史记录选择"),this.$emit("select",t,e);const a=D.end("历史记录选择");console.log(`📜 历史记录选择完成，耗时: ${a}ms`)},confirmClear(){this.showConfirmDialog=!0},clearHistory(){this.$emit("clear"),this.showConfirmDialog=!1}}},[["render",function(t,e,a,r,s,S){const _=n,C=u,T=p,D=R;return d(),i(_,{class:"tarot-history"},{default:o(()=>[l(_,{class:"history-header"},{default:o(()=>[l(_,{class:"history-title"},{default:o(()=>[h(g(a.title),1)]),_:1}),a.showClearButton?(d(),i(_,{key:0,class:"history-actions"},{default:o(()=>[l(C,{class:"clear-btn",onClick:S.confirmClear},{default:o(()=>[h("清除历史")]),_:1},8,["onClick"])]),_:1})):c("",!0)]),_:1}),S.isEmpty?(d(),i(_,{key:0,class:"history-empty"},{default:o(()=>[l(_,{class:"empty-text"},{default:o(()=>[h(g(a.emptyText),1)]),_:1})]),_:1})):(d(),i(_,{key:1,class:"history-list"},{default:o(()=>[(d(!0),m(y,null,f(a.historyItems,(t,e)=>(d(),i(_,{class:"history-item",key:e,onClick:a=>S.selectItem(t,e)},{default:o(()=>[l(_,{class:"item-date"},{default:o(()=>[h(g(t.date),1)]),_:2},1024),l(_,{class:"item-cards"},{default:o(()=>[(d(!0),m(y,null,f(t.cards,(t,e)=>(d(),i(_,{class:"mini-card",key:e},{default:o(()=>[l(T,{class:w(["mini-card-image",{"reversed-image":!1===t.isUpright}]),src:t.img,mode:"aspectFit"},null,8,["src","class"])]),_:2},1024))),128))]),_:2},1024),l(_,{class:"item-preview"},{default:o(()=>[h(g(S.getPreviewText(t.reading)),1)]),_:2},1024),l(_,{class:"item-arrow"},{default:o(()=>[l(D,{class:"arrow-icon"},{default:o(()=>[h("›")]),_:1})]),_:1})]),_:2},1032,["onClick"]))),128))]),_:1})),s.showConfirmDialog?(d(),i(_,{key:2,class:"confirm-dialog"},{default:o(()=>[l(_,{class:"dialog-content"},{default:o(()=>[l(_,{class:"dialog-title"},{default:o(()=>[h("确认清除")]),_:1}),l(_,{class:"dialog-message"},{default:o(()=>[h("确定要清除所有历史记录吗？此操作不可恢复。")]),_:1}),l(_,{class:"dialog-buttons"},{default:o(()=>[l(C,{class:"cancel-btn",onClick:e[0]||(e[0]=t=>s.showConfirmDialog=!1)},{default:o(()=>[h("取消")]),_:1}),l(C,{class:"confirm-btn",onClick:S.clearHistory},{default:o(()=>[h("确认清除")]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})):c("",!0)]),_:1})}],["__scopeId","data-v-5d060d40"]])},data:()=>({showHistory:!1,cardPositions:["过去/根源","现在/情况","未来/结果"]}),computed:{tarotStore:()=>x()},onLoad(){this.tarotStore.setCurrentDate(),this.tarotStore.checkTodayReading()},onShow(){this.tarotStore.checkTodayReading(),this.tarotStore.hasTodayReading||this.tarotStore.resetToInitial()},methods:{async handleDeckClick(){if(!this.tarotStore.isDrawing&&!this.tarotStore.hasTodayReading){D.start("塔罗完整体验");try{await this.tarotStore.startDrawing(),await this.startReading();const t=D.end("塔罗完整体验");console.log(`🎉 塔罗完整体验结束，总耗时: ${t}ms`)}catch(t){D.end("塔罗完整体验"),console.error("塔罗体验过程出错:",t)}}},async startReading(){D.start("今日塔罗完整流程");try{await this.tarotStore.startReading();const t=D.end("今日塔罗完整流程");console.log(`✅ 今日塔罗完整流程结束，总耗时: ${t}ms`)}catch(t){D.end("今日塔罗完整流程"),console.error("塔罗解读过程出错:",t)}},async shareReading(){try{const t={title:"今日塔罗解读",date:this.tarotStore.currentDate,cards:this.tarotStore.currentCards,content:this.tarotStore.currentReading,question:"今日运势"};await T(t)}catch(t){console.error("分享失败:",t),s({title:"分享失败",icon:"none",duration:2e3})}},saveReading(){try{const t={title:"今日塔罗解读",date:this.tarotStore.currentDate,cards:this.tarotStore.currentCards,content:this.tarotStore.currentReading,question:"今日运势",type:"daily"};C(t)}catch(t){console.error("保存失败:",t),s({title:"保存失败",icon:"none",duration:2e3})}},selectHistoryItem(t){D.start("加载历史解读");try{this.tarotStore.currentCards=t.cards,this.tarotStore.currentReading=t.reading,this.tarotStore.formatReading();const e=D.end("加载历史解读");console.log(`📜 历史解读加载完成，耗时: ${e}ms`)}catch(e){D.end("加载历史解读"),console.error("加载历史解读出错:",e)}this.showHistory=!1}}},[["render",function(t,e,a,r,s,u){const m=n,y=R,f=p,_=S("TarotDrawing"),C=S("TarotReading"),T=S("TarotHistory");return d(),i(m,{class:"daily-container"},{default:o(()=>[l(m,{class:"header"},{default:o(()=>[l(m,{class:"title"},{default:o(()=>[h("今日塔罗")]),_:1}),l(m,{class:"subtitle"},{default:o(()=>[h("每日运势指引")]),_:1})]),_:1}),u.tarotStore.isDrawing||u.tarotStore.isReading||u.tarotStore.currentReading?c("",!0):(d(),i(m,{key:0,class:"content"},{default:o(()=>[l(m,{class:"instruction"},{default:o(()=>[l(m,{class:"instruction-title"},{default:o(()=>[h("今日塔罗解读")]),_:1}),l(m,{class:"instruction-text"},{default:o(()=>[h("通过塔罗牌了解今天的运势和指引。每天只能抽取一次，结果将保存至明天。")]),_:1})]),_:1}),l(m,{class:"date-display"},{default:o(()=>[l(m,{class:"current-date"},{default:o(()=>[h(g(u.tarotStore.currentDate),1)]),_:1}),u.tarotStore.hasTodayReading?(d(),i(m,{key:0,class:"time-remaining"},{default:o(()=>[l(y,null,{default:o(()=>[h("今日已抽取")]),_:1}),l(y,{class:"refresh-time"},{default:o(()=>[h(g(u.tarotStore.refreshTimeText),1)]),_:1})]),_:1})):c("",!0)]),_:1}),l(m,{class:w(["card-deck",{disabled:u.tarotStore.isDrawing||u.tarotStore.hasTodayReading}]),onClick:u.handleDeckClick},{default:o(()=>[l(f,{class:"start-image",src:H,mode:"aspectFit"}),l(m,{class:"deck-text"},{default:o(()=>[h(g(u.tarotStore.hasTodayReading?"查看今日解读":"点击抽牌"),1)]),_:1})]),_:1},8,["onClick","class"])]),_:1})),u.tarotStore.isDrawing?(d(),i(_,{key:1,isDrawing:u.tarotStore.isDrawing,drawingText:"正在洗牌...",drawnCards:u.tarotStore.currentCards,progress:u.tarotStore.drawingProgress,cardCount:3},null,8,["isDrawing","drawingText","drawnCards","progress"])):c("",!0),u.tarotStore.isReading||u.tarotStore.currentReading?(d(),i(C,{key:2,title:"今日塔罗解读",date:u.tarotStore.currentDate,cards:u.tarotStore.currentCards,positions:s.cardPositions,content:u.tarotStore.formattedReading,isFormatted:!0,loading:u.tarotStore.isReading,loadingText:"正在解读塔罗牌...",onShare:u.shareReading,onSave:u.saveReading},null,8,["date","cards","positions","content","loading","loadingText","onShare","onSave"])):c("",!0),s.showHistory?(d(),i(m,{key:3,class:"history-modal"},{default:o(()=>[l(m,{class:"modal-overlay",onClick:e[0]||(e[0]=t=>s.showHistory=!1)}),l(m,{class:"modal-content"},{default:o(()=>[l(m,{class:"modal-header"},{default:o(()=>[l(m,{class:"modal-title"},{default:o(()=>[h("历史解读记录")]),_:1}),l(m,{class:"modal-close",onClick:e[1]||(e[1]=t=>s.showHistory=!1)},{default:o(()=>[h("×")]),_:1})]),_:1}),l(T,{historyItems:u.tarotStore.sortedHistory,onSelect:u.selectHistoryItem,onClear:u.tarotStore.clearHistory},null,8,["historyItems","onSelect","onClear"])]),_:1})]),_:1})):c("",!0)]),_:1})}],["__scopeId","data-v-39062049"]]);export{P as default};
